dist: bionic
language: crystal
crystal:
  - latest
  - nightly
git:
  submodules: false

before_install:
  - wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
  - sudo add-apt-repository 'deb http://apt.llvm.org/xenial/ llvm-toolchain-xenial-8 main'
  - sudo apt-get update
  - sudo apt-get install -y llvm-8-dev libclang-8-dev clang-8 libprocps-dev

script:
  - shards update
  - sed '1{s/llvm-7/llvm-8/;s/LLVM-7/LLVM-8/}' -i ./lib/llvm-crystal/src/lib_llvm_c.cr
  - sed 's/"clang"/"klang"/' -i ./lib/clang/src/lib_clang.cr
  - (cd docker && cp bin/libclang.so.gz /tmp/libclang.so.gz && gzip -d /tmp/libclang.so.gz;)
  - sudo rm -rf /usr/local/clang-7.0.0/lib
  - sudo mkdir -p /usr/local/clang-7.0.0/lib
  - sudo cp /tmp/libclang.so /usr/local/clang-7.0.0/lib/libklang.so
  - make
  - ./tests/backend/test-runner
  - ./tests/frontend/test-all
